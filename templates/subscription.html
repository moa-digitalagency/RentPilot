
<!--
* Nom de l'application : RentPilot
* Description : Template for subscription page.
* Produit de : MOA Digital Agency, www.myoneart.com
* Fait par : Aisance KALONJI, www.aisancekalonji.com
* Auditer par : La CyberConfiance, www.cyberconfiance.com
-->
{% extends "base.html" %}

{% block title %}Mon Abonnement - RentPilot{% endblock %}

{% block content %}
<div class="container mx-auto max-w-5xl p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Mon Abonnement</h1>

    <!-- Current Plan Info -->
    <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 rounded-3xl p-8 text-white shadow-xl mb-10 relative overflow-hidden">
        <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
        <div class="relative z-10 flex flex-col md:flex-row justify-between items-center">
            <div>
                <p class="text-indigo-200 font-medium mb-1">Forfait Actuel</p>
                <h2 class="text-4xl font-bold mb-2">{{ current_plan.name if current_plan else 'Gratuit' }}</h2>
                <ul class="flex gap-4 mt-4 text-sm font-medium text-indigo-100">
                    {% if current_plan and current_plan.features_json %}
                        {% for feature, enabled in current_plan.features_json.items() %}
                            {% if enabled %}
                            <li class="flex items-center"><svg class="w-4 h-4 mr-1 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> {{ feature }}</li>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="mt-6 md:mt-0 text-center md:text-right">
                <p class="text-3xl font-bold">{{ "%.2f"|format(current_plan.price_monthly) if current_plan else "0.00" }} €</p>
                <p class="text-indigo-200 text-sm">/ mois</p>
                {% if current_plan and current_plan.price_monthly > 0 %}
                <button class="mt-4 px-6 py-2 bg-white text-indigo-600 rounded-xl font-bold shadow hover:bg-indigo-50 transition-colors">
                    Changer de forfait
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Invoices List -->
    <h3 class="text-xl font-bold text-gray-800 mb-4">Historique des Factures</h3>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Numéro</th>
                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Montant</th>
                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Statut</th>
                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase text-right">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for invoice in saas_invoices %}
                <tr class="hover:bg-gray-50/50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">#{{ invoice.id }}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">{{ invoice.created_at.strftime('%d/%m/%Y') }}</td>
                    <td class="px-6 py-4 text-sm font-bold text-gray-900">{{ "%.2f"|format(invoice.amount) }} €</td>
                    <td class="px-6 py-4">
                        {% if invoice.status.name == 'PAID' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">Payé</span>
                        {% elif invoice.status.name == 'OFFLINE_PENDING' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">Vérification en cours</span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-rose-100 text-rose-800">À Payer</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                        {% if invoice.status.name == 'UNPAID' %}
                            <button onclick="openPaymentModal({{ invoice.id }}, {{ invoice.amount }})" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">Payer</button>
                        {% elif invoice.pdf_url %}
                            <a href="{{ url_for('static', filename=invoice.pdf_url) }}" target="_blank" class="text-gray-500 hover:text-gray-700 text-sm">PDF</a>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">Aucune facture.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Offline Payment Modal -->
<div id="payment-modal" class="fixed inset-0 bg-gray-900/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-gray-800">Régler la facture <span id="modal-invoice-id"></span></h3>
            <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>

        <div class="p-6">
            <p class="text-sm text-gray-600 mb-4">Veuillez effectuer un virement de <span id="modal-amount" class="font-bold text-gray-900"></span> vers le compte suivant, puis téléverser la preuve.</p>

            <div class="bg-gray-100 p-3 rounded-lg text-sm text-gray-700 font-mono mb-6">
                IBAN: FR76 1234 5678 9012 3456 7890 123<br>
                BIC: RENTFR2X
            </div>

            <form action="{{ url_for('finance.upload_saas_proof') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="invoice_id" id="form-invoice-id">

                <label class="block text-sm font-medium text-gray-700 mb-2">Preuve de virement (PDF, JPG, PNG)</label>
                <div class="relative border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer" onclick="document.getElementById('proof_file').click()">
                    <input type="file" name="proof_file" id="proof_file" class="hidden" required accept=".pdf,image/*" onchange="document.getElementById('file-name').textContent = this.files[0].name">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="mt-2 text-sm text-gray-500" id="file-name">Cliquez pour choisir un fichier</p>
                </div>

                <button type="submit" class="w-full mt-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow hover:bg-indigo-700 transition-colors">
                    Envoyer la preuve
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function openPaymentModal(id, amount) {
        document.getElementById('payment-modal').classList.remove('hidden');
        document.getElementById('modal-invoice-id').textContent = '#' + id;
        document.getElementById('modal-amount').textContent = amount.toFixed(2) + ' €';
        document.getElementById('form-invoice-id').value = id;
    }

    function closePaymentModal() {
        document.getElementById('payment-modal').classList.add('hidden');
    }
</script>
{% endblock %}