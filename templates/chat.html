{% extends "base.html" %}

{% block title %}Chat - RentPilot{% endblock %}

{% block content %}
<section id="view-chat" class="h-[calc(100vh-12rem)] animate-fade-in flex flex-col glass rounded-3xl overflow-hidden shadow-xl">
    <!-- Chat Header with Tabs -->
    <div class="flex-none p-4 border-b border-white/30 bg-white/40 backdrop-blur-md flex justify-between items-center">
        <div class="flex space-x-2 bg-gray-200/50 p-1 rounded-2xl">
            <button class="chat-tab active px-6 py-2 rounded-xl text-sm font-bold transition-all bg-white text-indigo-600 shadow-sm" data-tab="general">
                üè¢ <span class="hidden sm:inline ml-1">Chat G√©n√©ral</span>
            </button>
            <button class="chat-tab px-6 py-2 rounded-xl text-sm font-bold transition-all text-gray-500 hover:text-gray-700" data-tab="colocs">
                üè† <span class="hidden sm:inline ml-1">Entre Colocs</span>
            </button>
        </div>
        <div class="hidden md:flex items-center gap-2 text-xs font-medium text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            Live Connection
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar: Members (Left Column) -->
        <aside class="w-20 md:w-64 border-r border-white/20 bg-white/20 overflow-y-auto hidden sm:block">
            <div class="p-4 border-b border-white/10">
                <h4 class="text-xs font-bold uppercase tracking-wider text-gray-400">Membres</h4>
            </div>
            <div class="p-2 space-y-1">
                <!-- Member 1 -->
                <div class="flex items-center gap-3 p-3 rounded-2xl bg-white/40 border border-white/30 shadow-sm">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">M</div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div class="hidden md:block">
                        <p class="text-sm font-bold text-gray-900 leading-none">Moi</p>
                        <p class="text-[10px] text-gray-500 mt-1 uppercase">{{ current_user.role.value }}</p>
                    </div>
                </div>
                <!-- Member 2 -->
                <div class="flex items-center gap-3 p-3 rounded-2xl hover:bg-white/30 transition-colors cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center font-bold">S</div>
                    <div class="hidden md:block">
                        <p class="text-sm font-bold text-gray-700 group-hover:text-gray-900 leading-none">Sarah L.</p>
                        <p class="text-[10px] text-gray-400 mt-1 uppercase">Colocataire</p>
                    </div>
                </div>
                <!-- Member 3 -->
                <div class="flex items-center gap-3 p-3 rounded-2xl hover:bg-white/30 transition-colors cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold">L</div>
                    <div class="hidden md:block">
                        <p class="text-sm font-bold text-gray-700 group-hover:text-gray-900 leading-none">Lucas D.</p>
                        <p class="text-[10px] text-gray-400 mt-1 uppercase">Colocataire</p>
                    </div>
                </div>
                {% if current_user.role.value != 'Bailleur' %}
                <!-- Member 4 (Bailleur) -->
                <div class="flex items-center gap-3 p-3 rounded-2xl hover:bg-white/30 transition-colors cursor-pointer group">
                    <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center font-bold border border-gray-200">B</div>
                    <div class="hidden md:block">
                        <p class="text-sm font-bold text-gray-700 group-hover:text-gray-900 leading-none">M. Robert</p>
                        <p class="text-[10px] text-gray-400 mt-1 uppercase">Bailleur</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Chat Area (Right Column) -->
        <div class="flex-1 flex flex-col bg-white/10 backdrop-blur-sm relative">
            <!-- Messages Container -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6" id="messages-container">
                <!-- Date Divider -->
                <div class="flex justify-center">
                    <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400 bg-white/50 px-3 py-1 rounded-full">Aujourd'hui</span>
                </div>

                <!-- Message Left -->
                <div class="flex items-end gap-3 max-w-[85%]">
                    <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-600 text-xs font-bold flex-shrink-0 shadow-sm">S</div>
                    <div class="space-y-1">
                        <div class="bg-white p-4 rounded-2xl rounded-bl-none shadow-sm border border-white/50">
                            <p class="text-sm text-gray-800 leading-relaxed">Hello tout le monde ! J'ai command√© des pizzas pour ce soir si √ßa vous tente de manger ensemble dans le salon ? üçï</p>
                        </div>
                        <p class="text-[10px] text-gray-400 ml-1">Sarah ‚Ä¢ 18:42</p>
                    </div>
                </div>

                <!-- Message Right (Me) -->
                <div class="flex items-end gap-3 justify-end ml-auto max-w-[85%]">
                    <div class="space-y-1">
                        <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-br-none shadow-lg shadow-indigo-100">
                            <p class="text-sm leading-relaxed">Oh super id√©e ! Je serai l√† vers 19h30, merci Sarah ! üôå</p>
                        </div>
                        <p class="text-[10px] text-gray-400 text-right mr-1">Vu √† 18:45</p>
                    </div>
                </div>

                <!-- Message Left (Another member) -->
                <div class="flex items-end gap-3 max-w-[85%]">
                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs font-bold flex-shrink-0 shadow-sm">L</div>
                    <div class="space-y-1">
                        <div class="bg-white p-4 rounded-2xl rounded-bl-none shadow-sm border border-white/50">
                            <p class="text-sm text-gray-800 leading-relaxed">Carr√©ment ! Je m'occupe des boissons !</p>
                        </div>
                        <p class="text-[10px] text-gray-400 ml-1">Lucas ‚Ä¢ 18:50</p>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator (Hidden by default) -->
            <div id="typing-indicator" class="px-6 py-2 hidden">
                <p class="text-[10px] text-gray-400 italic">Sarah est en train d'√©crire...</p>
            </div>

            <!-- Message Input Area -->
            <div class="p-4 bg-white/60 border-t border-white/30 backdrop-blur-lg">
                <form id="chat-form" class="flex gap-3 items-center">
                    <button type="button" class="p-3 text-gray-400 hover:text-indigo-600 hover:bg-white rounded-xl transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <input type="text" id="message-input" placeholder="√âcrivez votre message..." class="w-full bg-white border-0 rounded-2xl px-5 py-3 pr-12 focus:ring-2 focus:ring-indigo-500/50 shadow-sm text-sm">
                    </div>
                    <button type="submit" class="p-3 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 shadow-xl shadow-indigo-200 transition-all hover:-translate-y-0.5 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Tab Switching Logic
    const tabs = document.querySelectorAll('.chat-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => {
                t.classList.remove('active', 'bg-white', 'text-indigo-600', 'shadow-sm');
                t.classList.add('text-gray-500');
            });
            tab.classList.add('active', 'bg-white', 'text-indigo-600', 'shadow-sm');
            tab.classList.remove('text-gray-500');

            // Here you would normally filter messages or load a different chat room
            console.log("Switching to tab:", tab.dataset.tab);
            refreshMessages();
        });
    });

    // Auto-scroll to bottom
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;

    // Simulate Fetch for Refreshing Messages
    async function refreshMessages() {
        console.log("Refreshing messages...");
        try {
            // Placeholder for actual API call:
            // const response = await fetch('/api/chat/messages');
            // const data = await response.json();
            // renderMessages(data);

            // For now, just a visual feedback
            const indicator = document.getElementById('typing-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 1000);
        } catch (error) {
            console.error("Failed to fetch messages:", error);
        }
    }

    // Refresh every 30 seconds
    setInterval(refreshMessages, 30000);

    // Form submission
    document.getElementById('chat-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if (!input.value.trim()) return;

        // Add message to UI (Optimistic UI)
        const msgHtml = `
            <div class="flex items-end gap-3 justify-end ml-auto max-w-[85%] animate-fade-in-up">
                <div class="space-y-1">
                    <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-br-none shadow-lg shadow-indigo-100">
                        <p class="text-sm leading-relaxed">${input.value}</p>
                    </div>
                    <p class="text-[10px] text-gray-400 text-right mr-1">Envoi...</p>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', msgHtml);
        container.scrollTop = container.scrollHeight;
        input.value = '';

        // Normally you would send this to the server:
        // fetch('/api/chat/send', { method: 'POST', body: JSON.stringify({ message: ... }) });
    });
</script>

<style>
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out forwards;
    }
</style>
{% endblock %}
